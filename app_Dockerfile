FROM continuumio/miniconda3
ADD app_environment.yml /tmp/environment.yml

ENTRYPOINT [ "/bin/bash", "-c" ]
EXPOSE 5000

COPY . /app
WORKDIR /app

RUN conda env create -f /tmp/environment.yml \
    && conda clean -afy \
    && find /opt/conda/ -follow -type f -name '*.a' -delete \
    && find /opt/conda/ -follow -type f -name '*.pyc' -delete \
    && find /opt/conda/ -follow -type f -name '*.js.map' -delete \

RUN echo "conda activate my_env_name" >> ~/.bashrc
ENV PATH /opt/conda/envs/my_env_name/bin:$PATH
CMD ["source activate my_env_name && exec python main.py"]
